<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Mundos de Minecraft</title>
  <style>
    body { font-family: sans-serif; background: #f2f2f2; padding: 20px; }
    h1 { color: #333; }
    .world {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
    }
    button { margin-right: 10px; }
  </style>
</head>
<body>
  <h1>Mundos de Minecraft</h1>
  <h2>Crear nuevo mundo</h2>
    <form id="formMundo">
    <input type="text" id="nombre" placeholder="Nombre del mundo" required>
    <input type="number" id="puerto" placeholder="Puerto (ej. 25565)" required>
    <input type="number" id="ram" placeholder="RAM (en MB)" required>
    <button type="submit">Crear mundo</button>
    </form>
    <hr>

  <div id="worlds-container">Cargando...</div>

  <div id="modalJugadores" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:white; padding:20px; border:1px solid #ccc; z-index:1000;">
    <h3>Usuarios permitidos</h3>
    <textarea id="listaJugadores" rows="6" cols="30" placeholder="Un nombre por l√≠nea..."></textarea><br><br>
    <button onclick="guardarJugadores()">Guardar</button>
    <button onclick="cerrarModal()">Cancelar</button>
  </div>
  

  <script>
    const token = localStorage.getItem('token');

    if (!token) {
      window.location.href = '/login.html';
    }

    async function cargarMundos() {
      try {
        const res = await fetch('/mundos', {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
          throw new Error("Sesi√≥n expirada");
        }

        const mundos = await res.json();
        const contenedor = document.getElementById('worlds-container');
        contenedor.innerHTML = '';

        if (mundos.length === 0) {
          contenedor.innerHTML = '<p>No tienes mundos creados a√∫n.</p>';
          return;
        }

        mundos.forEach(m => {
        const div = document.createElement('div');
        div.className = 'world';

        const encender = document.createElement('button');
        encender.textContent = 'Encender';
        encender.onclick = () => cambiarEstadoMundo(m._id, 'running');

        const apagar = document.createElement('button');
        apagar.textContent = 'Apagar';
        apagar.onclick = () => cambiarEstadoMundo(m._id, 'stopped');

        const editar = document.createElement('button');
        editar.textContent = 'Usuarios permitidos';
        editar.onclick = () => mostrarModal(m._id, m.jugadores || []);

        
        
        div.innerHTML = `
        <strong>${m.nombre}</strong><br>
        Estado: <span>${m.status}</span><br>
        Puerto: ${m.puerto}<br>
        `;
        
        div.appendChild(encender);
        div.appendChild(apagar);
        div.appendChild(editar);
        document.getElementById('worlds-container').appendChild(div);
        });

      } catch (err) {
        alert(err.message);
        localStorage.removeItem('token');
        window.location.href = '/login.html';
      }
    }

    cargarMundos();

    document.getElementById('formMundo').addEventListener('submit', async (e) => {
    e.preventDefault();

    const nombre = document.getElementById('nombre').value;
    const puerto = parseInt(document.getElementById('puerto').value);
    const ram = parseInt(document.getElementById('ram').value);

    try {
        const res = await fetch('/crear-mundo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ nombre, puerto, ram })
        });

        if (!res.ok) {
        const err = await res.text();
        throw new Error(err);
        }

        alert("üåç Mundo creado correctamente");
        cargarMundos();

    } catch (err) {
        alert("‚ö†Ô∏è " + err.message);
    }
    });

    async function cambiarEstadoMundo(id, nuevoEstado) {
    try {
        const res = await fetch(`/mundo/${id}/${nuevoEstado}`, {
        method: 'PATCH',
        headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('No se pudo cambiar el estado');

        alert('‚úÖ Mundo actualizado');
        cargarMundos();

    } catch (err) {
        alert('‚ö†Ô∏è ' + err.message);
    }
    }
    let mundoActual = null;

function mostrarModal(id, jugadores) {
  mundoActual = id;
  const textarea = document.getElementById('listaJugadores');
  textarea.value = jugadores.join('\n');
  document.getElementById('modalJugadores').style.display = 'block';
}

function cerrarModal() {
  document.getElementById('modalJugadores').style.display = 'none';
  mundoActual = null;
}

async function guardarJugadores() {
  const lista = document.getElementById('listaJugadores').value
    .split('\n')
    .map(j => j.trim())
    .filter(j => j.length > 0);

  try {
    const res = await fetch(`/mundo/${mundoActual}/jugadores`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ jugadores: lista })
    });

    if (!res.ok) throw new Error('Error al guardar jugadores');

    alert('‚úÖ Lista actualizada');
    cerrarModal();
    cargarMundos();

  } catch (err) {
    alert('‚ö†Ô∏è ' + err.message);
  }
}

  </script>
</body>
</html>
